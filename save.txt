type Game @entity {
  id: ID! # game room
  boards: [Bytes!]!
  moves: [Move!]! @derivedFrom(field: "game")
  started: Boolean!
  winner: Bytes! # address of winning user
  won: Boolean!
}

type Move @entity {
  id: ID!
  by: Bytes!
  game: Game!
  landed: Boolean!
  proof: Bytes
}


{
  "_format": "hh-sol-artifact-1",
  "contractName": "ZKBattleship",
  "sourceName": "contracts/ZKBattleship.sol",
  "abi": [
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": true,
          "internalType": "uint256",
          "name": "_room",
          "type": "uint256"
        }
      ],
      "name": "GameCreated",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": true,
          "internalType": "uint256",
          "name": "_room",
          "type": "uint256"
        }
      ],
      "name": "GameStarted",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": true,
          "internalType": "uint256",
          "name": "_room",
          "type": "uint256"
        },
        {
          "indexed": false,
          "internalType": "bytes",
          "name": "_proof",
          "type": "bytes"
        }
      ],
      "name": "Placed",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": true,
          "internalType": "uint256",
          "name": "_room",
          "type": "uint256"
        },
        {
          "indexed": false,
          "internalType": "uint8",
          "name": "_x",
          "type": "uint8"
        },
        {
          "indexed": false,
          "internalType": "uint8",
          "name": "_y",
          "type": "uint8"
        },
        {
          "indexed": false,
          "internalType": "address",
          "name": "_by",
          "type": "address"
        }
      ],
      "name": "ShotFired",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": true,
          "internalType": "uint256",
          "name": "_room",
          "type": "uint256"
        },
        {
          "indexed": false,
          "internalType": "uint8",
          "name": "_x",
          "type": "uint8"
        },
        {
          "indexed": false,
          "internalType": "uint8",
          "name": "_y",
          "type": "uint8"
        },
        {
          "indexed": false,
          "internalType": "bytes",
          "name": "_proof",
          "type": "bytes"
        }
      ],
      "name": "ShotLanded",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": true,
          "internalType": "uint256",
          "name": "_room",
          "type": "uint256"
        },
        {
          "indexed": false,
          "internalType": "address",
          "name": "_winner",
          "type": "address"
        }
      ],
      "name": "Won",
      "type": "event"
    },
    {
      "inputs": [],
      "name": "WIDTH",
      "outputs": [
        {
          "internalType": "uint8",
          "name": "",
          "type": "uint8"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "WIN_HITS",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "bytes",
          "name": "_board",
          "type": "bytes"
        },
        {
          "internalType": "bytes",
          "name": "_proof",
          "type": "bytes"
        }
      ],
      "name": "createGame",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "",
          "type": "address"
        }
      ],
      "name": "gameLock",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "gameNonce",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "name": "games",
      "outputs": [
        {
          "internalType": "bool",
          "name": "firefight",
          "type": "bool"
        },
        {
          "internalType": "enum IZKBattleship.Phase",
          "name": "phase",
          "type": "uint8"
        },
        {
          "internalType": "bool",
          "name": "turn",
          "type": "bool"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "_room",
          "type": "uint256"
        },
        {
          "internalType": "bytes",
          "name": "_board",
          "type": "bytes"
        },
        {
          "internalType": "bytes",
          "name": "_proof",
          "type": "bytes"
        }
      ],
      "name": "joinGame",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "_room",
          "type": "uint256"
        },
        {
          "internalType": "uint8",
          "name": "_x",
          "type": "uint8"
        },
        {
          "internalType": "uint8",
          "name": "_y",
          "type": "uint8"
        },
        {
          "internalType": "bytes",
          "name": "_prevRound",
          "type": "bytes"
        }
      ],
      "name": "shoot",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "",
          "type": "address"
        },
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "name": "uuids",
      "outputs": [
        {
          "internalType": "uint8",
          "name": "",
          "type": "uint8"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    }
  ],
  "bytecode": "0x608060405234801561001057600080fd5b50610c34806100206000396000f3fe608060405234801561001057600080fd5b50600436106100925760003560e01c80638ba074e9116100665780638ba074e91461011f57806393ffb10014610132578063c69fa9ef1461013b578063cc03156d1461015b578063d44d33941461019b57600080fd5b80629d347a14610097578063117a5b90146100b25780633ef48bd1146100f75780638a57d5b61461010c575b600080fd5b61009f600381565b6040519081526020015b60405180910390f35b6100e86100c03660046108b9565b6001602052600090815260409020805460069091015460ff8083169261010090048116911683565b6040516100a993929190610a83565b61010a6101053660046108d2565b6101a3565b005b61010a61011a36600461093f565b6102ca565b61009f61012d366004610855565b61069c565b61009f60005481565b61009f610149366004610809565b60036020526000908152604090205481565b61018961016936600461082b565b600260209081526000928352604080842090915290825290205460ff1681565b60405160ff90911681526020016100a9565b610189600681565b33600090815260036020526040902054156101f75760405162461bcd60e51b815260206004820152600f60248201526e4164647265737320696e2067616d6560881b60448201526064015b60405180910390fd5b82600180600083815260016020526040902054610100900460ff16600481111561022357610223610baa565b146102625760405162461bcd60e51b815260206004820152600f60248201526e2120636f727265637420706861736560881b60448201526064016101ee565b50505060008281526001602090815260408083208354338086526003855283862091909155600280830180546001600160a01b03191690921790915580845282852096855295909252909120805460ff191690931790925550805461ff001916610300179055565b83600380600083815260016020526040902054610100900460ff1660048111156102f6576102f6610baa565b146103355760405162461bcd60e51b815260206004820152600f60248201526e2120636f727265637420706861736560881b60448201526064016101ee565b84600660ff82161061037a5760405162461bcd60e51b815260206004820152600e60248201526d42616420636f6f7264696e61746560901b60448201526064016101ee565b84600660ff8216106103bf5760405162461bcd60e51b815260206004820152600e60248201526d42616420636f6f7264696e61746560901b60448201526064016101ee565b3360009081526002602090815260408083208b8452909152902054889060ff1661041b5760405162461bcd60e51b815260206004820152600d60248201526c08481c185c9d1a58da5c185b9d609a1b60448201526064016101ee565b33600090815260026020818152604080842085855290915282205460ff169190821461045c5760008381526001602052604090206006015460ff1615610472565b60008381526001602052604090206006015460ff165b905080156104ab5760405162461bcd60e51b815260206004820152600660248201526510903a3ab93760d11b60448201526064016101ee565b60008b8152600160205260409020805460ff1615610628576000806000808c8060200190518101906104dd91906109ab565b929650909450925090506001600061058460038801830180546104ff90610b3e565b80601f016020809104026020016040519081016040528092919081815260200182805461052b90610b3e565b80156105785780601f1061054d57610100808354040283529160200191610578565b820191906000526020600020905b81548152906001019060200180831161055b57829003601f168201915b50600195945050505050565b9050806105c85760405162461bcd60e51b815260206004820152601260248201527124b73b30b634b21039b437ba10383937b7b360711b60448201526064016101ee565b6001876005018360ff16600281106105e2576105e2610bc0565b602091828204019190068282829054906101000a900460ff166106059190610b19565b92506101000a81548160ff021916908360ff160217905550505050505050610634565b805460ff191660011781555b60068101805460ff19811660ff9182161517909155604080518d83168152918c16602083015233908201528c907fa42a1d95d44e8495aa58c65fede596aada51115b8db8b8f89c5783e09b83f0849060600160405180910390a2505050505050505050505050565b33600090815260036020526040812054156106eb5760405162461bcd60e51b815260206004820152600f60248201526e4164647265737320696e2067616d6560881b60448201526064016101ee565b6000805490806106fa83610b79565b90915550506000805480825260016020818152604080852033808752600384528287209590955580840180546001600160a01b0319169095179094556002825280852085548652909152808420805460ff1916909217909155815461ff00191661010017825582549051919290917fbd19c47e9925eb6f7be8bb1c13a841e0240aaeaf17f217e90022e9c8eb66877f9190a2505060005492915050565b80356001600160a01b03811681146107ae57600080fd5b919050565b600082601f8301126107c457600080fd5b81356107d76107d282610af1565b610ac0565b8181528460208386010111156107ec57600080fd5b816020850160208301376000918101602001919091529392505050565b60006020828403121561081b57600080fd5b61082482610797565b9392505050565b6000806040838503121561083e57600080fd5b61084783610797565b946020939093013593505050565b6000806040838503121561086857600080fd5b823567ffffffffffffffff8082111561088057600080fd5b61088c868387016107b3565b935060208501359150808211156108a257600080fd5b506108af858286016107b3565b9150509250929050565b6000602082840312156108cb57600080fd5b5035919050565b6000806000606084860312156108e757600080fd5b83359250602084013567ffffffffffffffff8082111561090657600080fd5b610912878388016107b3565b9350604086013591508082111561092857600080fd5b50610935868287016107b3565b9150509250925092565b6000806000806080858703121561095557600080fd5b84359350602085013561096781610bec565b9250604085013561097781610bec565b9150606085013567ffffffffffffffff81111561099357600080fd5b61099f878288016107b3565b91505092959194509250565b600080600080608085870312156109c157600080fd5b84516109cc81610bec565b809450506020808601516109df81610bec565b604087015190945080151581146109f557600080fd5b606087015190935067ffffffffffffffff811115610a1257600080fd5b8601601f81018813610a2357600080fd5b8051610a316107d282610af1565b8181528984838501011115610a4557600080fd5b60005b82811015610a63578381018501518282018601528401610a48565b82811115610a745760008584840101525b50969995985093965050505050565b83151581526060810160058410610aaa57634e487b7160e01b600052602160045260246000fd5b8360208301528215156040830152949350505050565b604051601f8201601f1916810167ffffffffffffffff81118282101715610ae957610ae9610bd6565b604052919050565b600067ffffffffffffffff821115610b0b57610b0b610bd6565b50601f01601f191660200190565b600060ff821660ff84168060ff03821115610b3657610b36610b94565b019392505050565b600181811c90821680610b5257607f821691505b60208210811415610b7357634e487b7160e01b600052602260045260246000fd5b50919050565b6000600019821415610b8d57610b8d610b94565b5060010190565b634e487b7160e01b600052601160045260246000fd5b634e487b7160e01b600052602160045260246000fd5b634e487b7160e01b600052603260045260246000fd5b634e487b7160e01b600052604160045260246000fd5b60ff81168114610bfb57600080fd5b5056fea264697066735822122096541240c9266f8b1949ce7b71e32596fe3e90ecb7598b1c603cebbdc7c39bbf64736f6c63430008060033",
  "deployedBytecode": "0x608060405234801561001057600080fd5b50600436106100925760003560e01c80638ba074e9116100665780638ba074e91461011f57806393ffb10014610132578063c69fa9ef1461013b578063cc03156d1461015b578063d44d33941461019b57600080fd5b80629d347a14610097578063117a5b90146100b25780633ef48bd1146100f75780638a57d5b61461010c575b600080fd5b61009f600381565b6040519081526020015b60405180910390f35b6100e86100c03660046108b9565b6001602052600090815260409020805460069091015460ff8083169261010090048116911683565b6040516100a993929190610a83565b61010a6101053660046108d2565b6101a3565b005b61010a61011a36600461093f565b6102ca565b61009f61012d366004610855565b61069c565b61009f60005481565b61009f610149366004610809565b60036020526000908152604090205481565b61018961016936600461082b565b600260209081526000928352604080842090915290825290205460ff1681565b60405160ff90911681526020016100a9565b610189600681565b33600090815260036020526040902054156101f75760405162461bcd60e51b815260206004820152600f60248201526e4164647265737320696e2067616d6560881b60448201526064015b60405180910390fd5b82600180600083815260016020526040902054610100900460ff16600481111561022357610223610baa565b146102625760405162461bcd60e51b815260206004820152600f60248201526e2120636f727265637420706861736560881b60448201526064016101ee565b50505060008281526001602090815260408083208354338086526003855283862091909155600280830180546001600160a01b03191690921790915580845282852096855295909252909120805460ff191690931790925550805461ff001916610300179055565b83600380600083815260016020526040902054610100900460ff1660048111156102f6576102f6610baa565b146103355760405162461bcd60e51b815260206004820152600f60248201526e2120636f727265637420706861736560881b60448201526064016101ee565b84600660ff82161061037a5760405162461bcd60e51b815260206004820152600e60248201526d42616420636f6f7264696e61746560901b60448201526064016101ee565b84600660ff8216106103bf5760405162461bcd60e51b815260206004820152600e60248201526d42616420636f6f7264696e61746560901b60448201526064016101ee565b3360009081526002602090815260408083208b8452909152902054889060ff1661041b5760405162461bcd60e51b815260206004820152600d60248201526c08481c185c9d1a58da5c185b9d609a1b60448201526064016101ee565b33600090815260026020818152604080842085855290915282205460ff169190821461045c5760008381526001602052604090206006015460ff1615610472565b60008381526001602052604090206006015460ff165b905080156104ab5760405162461bcd60e51b815260206004820152600660248201526510903a3ab93760d11b60448201526064016101ee565b60008b8152600160205260409020805460ff1615610628576000806000808c8060200190518101906104dd91906109ab565b929650909450925090506001600061058460038801830180546104ff90610b3e565b80601f016020809104026020016040519081016040528092919081815260200182805461052b90610b3e565b80156105785780601f1061054d57610100808354040283529160200191610578565b820191906000526020600020905b81548152906001019060200180831161055b57829003601f168201915b50600195945050505050565b9050806105c85760405162461bcd60e51b815260206004820152601260248201527124b73b30b634b21039b437ba10383937b7b360711b60448201526064016101ee565b6001876005018360ff16600281106105e2576105e2610bc0565b602091828204019190068282829054906101000a900460ff166106059190610b19565b92506101000a81548160ff021916908360ff160217905550505050505050610634565b805460ff191660011781555b60068101805460ff19811660ff9182161517909155604080518d83168152918c16602083015233908201528c907fa42a1d95d44e8495aa58c65fede596aada51115b8db8b8f89c5783e09b83f0849060600160405180910390a2505050505050505050505050565b33600090815260036020526040812054156106eb5760405162461bcd60e51b815260206004820152600f60248201526e4164647265737320696e2067616d6560881b60448201526064016101ee565b6000805490806106fa83610b79565b90915550506000805480825260016020818152604080852033808752600384528287209590955580840180546001600160a01b0319169095179094556002825280852085548652909152808420805460ff1916909217909155815461ff00191661010017825582549051919290917fbd19c47e9925eb6f7be8bb1c13a841e0240aaeaf17f217e90022e9c8eb66877f9190a2505060005492915050565b80356001600160a01b03811681146107ae57600080fd5b919050565b600082601f8301126107c457600080fd5b81356107d76107d282610af1565b610ac0565b8181528460208386010111156107ec57600080fd5b816020850160208301376000918101602001919091529392505050565b60006020828403121561081b57600080fd5b61082482610797565b9392505050565b6000806040838503121561083e57600080fd5b61084783610797565b946020939093013593505050565b6000806040838503121561086857600080fd5b823567ffffffffffffffff8082111561088057600080fd5b61088c868387016107b3565b935060208501359150808211156108a257600080fd5b506108af858286016107b3565b9150509250929050565b6000602082840312156108cb57600080fd5b5035919050565b6000806000606084860312156108e757600080fd5b83359250602084013567ffffffffffffffff8082111561090657600080fd5b610912878388016107b3565b9350604086013591508082111561092857600080fd5b50610935868287016107b3565b9150509250925092565b6000806000806080858703121561095557600080fd5b84359350602085013561096781610bec565b9250604085013561097781610bec565b9150606085013567ffffffffffffffff81111561099357600080fd5b61099f878288016107b3565b91505092959194509250565b600080600080608085870312156109c157600080fd5b84516109cc81610bec565b809450506020808601516109df81610bec565b604087015190945080151581146109f557600080fd5b606087015190935067ffffffffffffffff811115610a1257600080fd5b8601601f81018813610a2357600080fd5b8051610a316107d282610af1565b8181528984838501011115610a4557600080fd5b60005b82811015610a63578381018501518282018601528401610a48565b82811115610a745760008584840101525b50969995985093965050505050565b83151581526060810160058410610aaa57634e487b7160e01b600052602160045260246000fd5b8360208301528215156040830152949350505050565b604051601f8201601f1916810167ffffffffffffffff81118282101715610ae957610ae9610bd6565b604052919050565b600067ffffffffffffffff821115610b0b57610b0b610bd6565b50601f01601f191660200190565b600060ff821660ff84168060ff03821115610b3657610b36610b94565b019392505050565b600181811c90821680610b5257607f821691505b60208210811415610b7357634e487b7160e01b600052602260045260246000fd5b50919050565b6000600019821415610b8d57610b8d610b94565b5060010190565b634e487b7160e01b600052601160045260246000fd5b634e487b7160e01b600052602160045260246000fd5b634e487b7160e01b600052603260045260246000fd5b634e487b7160e01b600052604160045260246000fd5b60ff81168114610bfb57600080fd5b5056fea264697066735822122096541240c9266f8b1949ce7b71e32596fe3e90ecb7598b1c603cebbdc7c39bbf64736f6c63430008060033",
  "linkReferences": {},
  "deployedLinkReferences": {}
}

specVersion: 0.0.2
schema:
  file: ./schema.graphql
dataSources:
  - kind: ethereum/contract
    name: ZKBattleship
    network: rinkeby
    source:
      address: "0x78019a3700fd84f22a78942ea21359a8353b786a"
      abi: ZKBattleship
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.4
      language: wasm/assemblyscript
      entities:
        - Stored
      abis:
        - name: ZKBattleship
          file: ./abis/ZKBattleship.json
      eventHandlers:
        - event: GameCreated(indexed uint256)
          handler: handleGameCreated
        - event: GameStarted(indexed uint256)
          handler: handleGameStarted
        - event: Placed(indexed uint256,bytes)
          handler: handlePlaced
        - event: ShotFired(indexed uint256,uint8,uint8,address)
          handler: handleShotFired
        - event: ShotLanded(indexed uint256,uint8,uint8,bytes)
          handler: handleShotLanded
        - event: Won(indexed uint256,address)
          handler: handleWin
      file: ./src/mapping.ts


import { GameStarted, Placed, ShotFired, ShotLanded, Won } from "../generated/ZKBattleship/ZKBattleship"
import { Game, Move } from "../generated/schema"

export function handleGameCreated(event: GameStarted): void {
  const id = event.params._room.toHex();
  const game = new Game(id);
  game.moves = [];
  game.started = true;
  game.won = false;
  game.save();
}

export function handleShotFired(event: ShotFired): void {
  const id = event.params._room.toHex();
  const move_id = event.params._x.toHexString().concat('-').concat(event.params._y.toString());
  const move = new Move(move_id);
  move.by = event.params._by;
  move.landed = false;
  move.game = id;
  move.save();
}

export function handlePlaced(event: Placed): void {
  const id = event.params._room.toHex();
  const game = Game.load(id);
  const boards = new Array<any>();
  if (game.boards[0]) {
    boards.push(game.boards[0]);
    boards.push(event.params._proof);
  } else {
    boards.push(event.params._proof);
  }
  game.boards = boards;
  game.save();
}

export function handleShotLanded(event: ShotLanded): void {
  const id = event.params._x.toHexString().concat('-').concat(event.params._y.toString());
  const move = Move.load(id);
  move.landed = true;
  move.save();
}

export function handleWin(event: Won): void {
  const id = event.params._room.toHexString();
  const game = Game.load(id);
  game.won = true;
  game.winner = event.params._winner;
  game.save();
}
